---
apiVersion: flux.weave.works/v1beta1
kind: HelmRelease
metadata:
  name: gitlab
  namespace: gitlab
spec:
  releaseName: gitlab
  chart:
    repository: https://charts.gitlab.io/
    name: gitlab
    version: 2.1.7
  values:
    certmanager:
      install: false
    gitlab:
      task-runner:
        backups:
          objectStorage:
            config:
              key: config
              secret: backup-storage-config
      unicorn:
        ingress:
          tls:
            secretName: gitlab-unicorn-tls
    global:
      appConfig:
        omniauth:
          enabled: true
          allowSingleSignOn:
          - azure_oauth2
          autoLinkLdapUser: true
          autoLinkSamlUser: false
          autoSignInWithProvider: null
          blockAutoCreatedUsers: false
          providers:
          - secret: gitlab-azure-oauth2
        artifacts:
          bucket: gitlab-artifacts-storage
          connection:
            key: connection
            secret: gitlab-rails-storage
        backups:
          bucket: gitlab-backup-storage
          tmpBucket: gitlab-tmp-storage
        lfs:
          bucket: gitlab-lfs-storage
          connection:
            key: connection
            secret: gitlab-rails-storage
        packages:
          bucket: gitlab-packages-storage
          connection:
            key: connection
            secret: gitlab-rails-storage
        uploads:
          bucket: gitlab-uploads-storage
          connection:
            key: connection
            secret: gitlab-rails-storage
        pseudonymizer:
          bucket: gitlab-pseudonymizer-storage
          connection:
            key: connection
            secret: gitlab-rails-storage
      edition: ce
      hosts:
        domain: dev.sdpaks.equinor.com
        externalIP: ""
        https: true
      ingress:
        class: nginx
        annotations:
          kubernetes.io/tls-acme: true
        configureCertmanager: false
      minio:
        enabled: false
      psql:
        database: postgres
        host: gitlab-postgressql.postgres.database.azure.com
        password:
          key: password
          secret: gitlab-postgres-secret
        username: gitlab@gitlab-postgressql
    nginx-ingress:
      enabled: false
    postgresql:
      install: false
    registry:
      bucket: gitlab-registry-storage
      ingress:
        tls:
          secretName: gitlab-registry-tls
      storage:
        key: config
        secret: registry-storage
    gitlab-runner:
      envVars:
        - name: LISTEN_ADDRESS
          value: :9252
    #https://gitlab.com/gitlab-org/charts/gitlab/blob/master/doc/installation/deployment.md#outgoing-email
    #https://gitlab.com/gitlab-org/charts/gitlab/blob/master/doc/installation/command-line-options.md#outgoing-email-configuration
    smtp:
      enabled: true
      address: smtp.TODO.org
      port: 2525
      user_name: "TODO"
      ## doc/installation/secrets.md#smtp-password
      password:
        secret: gitlab-smtp-tls
        key: password
      # domain:
      authentication: "plain"
      starttls_auto: false
      openssl_verify_mode: "peer"
    email:
      from: 'gm_sds_rdi@equinor.com'
      display_name: "Gitlab Equinor"
      reply_to: ''
      subject_suffix: ''
      smime:
        enabled: false
        secretName: gitlab-email-tls
        keyName: "tls.key"
        certName: "tls.crt"
