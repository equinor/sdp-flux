# Performance metrics to get insight in the clusterstatus. Supports alerts to get notified if something goes avry.
---
apiVersion: flux.weave.works/v1beta1
kind: HelmRelease
metadata:
  name: prometheus-operator
  namespace: monitoring
spec:
  values:
    alertmanager:
      ingress:
        enabled: true
        hosts:
        - alertmanager.sdpaks.equinor.com
        tls:
        - secretName: alertmanager-tls
          hosts:
          - alertmanager.sdpaks.equinor.com

    grafana:
      env:
        GF_SERVER_ROOT_URL: https://grafana.sdpaks.equinor.com

      envFromSecret: grafana-secret-envs # Secret with GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET

      ingress:
        enabled: true
        hosts:
        - grafana.sdpaks.equinor.com
        tls:
        - secretName: grafana-tls
          hosts:
          - grafana.sdpaks.equinor.com

    kubeApiServer:
      tlsConfig:
        insecureSkipVerify: true

    prometheus:
      prometheusSpec:
        storageSpec:
          volumeClaimTemplate:
            spec:
              accessModes:
                - ReadWriteOnce
              storageClassName: managed-premium
              resources:
                requests:
                  storage: 30Gi # Storage size calculation: https://prometheus.io/docs/prometheus/latest/storage/#operational-aspects
        serviceMonitorSelector:
          matchLabels:
            release: prometheus-operator
        serviceMonitorNamespaceSelector: {}
      ingress:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: nginx
          kubernetes.io/tls-acme: "true"
          nginx.ingress.kubernetes.io/auth-url: "https://$host/oauth2/auth"
          nginx.ingress.kubernetes.io/auth-signin: "https://$host/oauth2/start?rd=$escaped_request_uri"
        hosts:
        - prometheus.sdpaks.equinor.com
        tls:
        - secretName: prometheus-tls
          hosts:
          - prometheus.sdpaks.equinor.com

    coreDns:
      enabled: true

    kubeDns:
      enabled: true
    
    defaultRules:
      rules:
        kubeApiServer: false
        kubeScheduler: false
    
    resources:
      requests:
        cpu: 250m
        memory: "2Gi"
      limits:
        cpu: 1000m
        memory: "10Gi"
